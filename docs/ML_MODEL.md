# MCPScan ML Model Documentation

## Overview

MCPScan uses a machine learning model to assess security risk in MCP (Model Context Protocol) configurations. The model provides a risk score (0.0-1.0) and risk level classification (minimal, low, medium, high, critical).

## Model Architecture

### Ensemble Approach

The model uses an ensemble of two complementary algorithms:

| Component | Algorithm | Purpose | Weight |
|-----------|-----------|---------|--------|
| Primary Classifier | Random Forest | Risk level prediction | 70% |
| Anomaly Detector | Isolation Forest | Unusual config detection | 30% |

### Random Forest Configuration

```
n_estimators: 200
max_depth: 15
min_samples_split: 5
min_samples_leaf: 2
max_features: sqrt
class_weight: balanced
```

### Isolation Forest Configuration

```
n_estimators: 100
contamination: 0.1
```

## Features

The model uses 31 security-relevant features extracted from MCP configurations:

### Structural Features (7)
- `num_servers` - Number of MCP servers
- `num_tools` - Total tools across servers
- `num_env_vars` - Environment variables count
- `num_args` - Command arguments count
- `has_remote_servers` - Remote server presence
- `has_local_servers` - Local server presence
- `config_complexity` - Overall complexity score

### Credential Exposure Features (4)
- `num_hardcoded_secrets` - Detected credentials
- `num_api_key_patterns` - API key patterns
- `num_token_patterns` - Token patterns
- `sensitive_env_exposure` - Sensitive env vars with values

### Injection Risk Features (3)
- `num_command_injection_patterns` - Shell injection patterns
- `num_shell_metacharacters` - Dangerous characters
- `num_path_traversal_patterns` - Path traversal sequences

### Network Risk Features (3)
- `num_internal_urls` - Internal/localhost URLs
- `num_metadata_endpoints` - Cloud metadata endpoints
- `num_private_network_refs` - Private network references

### Tool Risk Features (5)
- `num_dangerous_tools` - Dangerous tool capabilities
- `num_file_access_tools` - File system tools
- `num_network_tools` - Network access tools
- `num_exec_tools` - Code execution tools
- `has_privileged_tools` - Privileged access

### Authentication Features (3)
- `has_auth_indicators` - Auth configuration present
- `num_auth_configs` - Auth config count
- `uses_env_references` - Uses ${VAR} references

### OWASP MCP Top 10 Scores (6)
- `mcp01_token_exposure_score` - Token mismanagement
- `mcp02_privilege_escalation_score` - Privilege escalation
- `mcp03_tool_poisoning_score` - Tool poisoning risk
- `mcp05_command_injection_score` - Command injection
- `mcp06_prompt_injection_score` - Prompt injection
- `mcp07_auth_weakness_score` - Authentication weakness

## Model Performance

### Current Metrics (v1.0.0)

| Metric | Value |
|--------|-------|
| Accuracy | 93.20% |
| Precision | 93.21% |
| Recall | 93.20% |
| F1 Score | 93.18% |
| Cross-Validation | 87.81% ± 4.46% |

### Per-Class Performance

| Class | Precision | Recall | F1-Score |
|-------|-----------|--------|----------|
| Critical | 97% | 99% | 98% |
| High | 97% | 93% | 95% |
| Medium | 89% | 93% | 91% |
| Low | 86% | 83% | 84% |
| Minimal | 94% | 93% | 93% |

### Top Feature Importance

1. `mcp02_privilege_escalation_score` (13.54%)
2. `num_dangerous_tools` (9.45%)
3. `mcp03_tool_poisoning_score` (8.06%)
4. `mcp07_auth_weakness_score` (7.64%)
5. `config_complexity` (5.98%)

## Known Limitations

### ⚠️ Training Data Limitations

1. **Synthetic Data Only**
   - Model trained on 5,000 synthetic samples
   - No real-world MCP configurations in training set
   - Patterns based on theoretical vulnerability knowledge

2. **Same-Distribution Testing**
   - Test set generated by same process as training set
   - 93% accuracy may not generalize to real configs
   - Cross-validation performed on synthetic data only

3. **Pattern Coverage**
   - Covers OWASP MCP Top 10 patterns
   - May miss novel or uncommon vulnerability patterns
   - Limited to known credential formats (OpenAI, AWS, etc.)

### ⚠️ Model Limitations

1. **No Semantic Understanding**
   - Model uses pattern matching, not semantic analysis
   - Cannot understand business context
   - May flag legitimate configurations as risky

2. **False Positives Expected**
   - Internal URLs may be intentional (development)
   - Some tools flagged as "dangerous" may be necessary
   - Hardcoded values in examples/tests may trigger alerts

3. **False Negatives Possible**
   - Novel credential formats not in training data
   - Obfuscated or encoded secrets
   - Indirect vulnerability patterns

### ⚠️ Deployment Considerations

1. **Rule-Based Fallback**
   - Model falls back to rule-based scoring if ML unavailable
   - Ensures functionality without trained model
   - Rule-based may differ from ML predictions

2. **Confidence Scores**
   - High confidence (>90%) indicates clear patterns
   - Low confidence (<70%) suggests uncertainty
   - Anomaly flag indicates unusual configuration

3. **Recommended Usage**
   - Use as advisory, not definitive security assessment
   - Combine with manual security review
   - Validate findings before taking action

## Improving the Model

### Collecting Real-World Data

Use the data collection feature to gather real MCP configs:

```bash
# Collect from local system
mcpscan collect --scan-system

# Collect from specific directory
mcpscan collect --dir /path/to/configs

# Submit anonymized data (optional)
mcpscan collect --submit
```

### Validating on Real Configs

```bash
# Validate model on real configs
mcpscan validate-model --dir /path/to/configs

# Generate validation report
mcpscan validate-model --dir /path/to/configs --report validation.json
```

### Retraining

```bash
# Retrain with additional data
mcpscan train --real-data /path/to/collected --samples 5000
```

## Version History

| Version | Date | Changes |
|---------|------|---------|
| v1.0.0 | 2025-12-25 | Initial release with Random Forest ensemble |

## References

- [OWASP MCP Top 10](https://genai.owasp.org/)
- [MCP Security Best Practices](https://modelcontextprotocol.io/docs/concepts/security)
- [CWE Vulnerability Database](https://cwe.mitre.org/)
